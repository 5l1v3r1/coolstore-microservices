<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Microservices Development | Coolstore Microservices</title>
    <meta name="description" content="Coolstore Microservices">
    <link rel="icon" href="/coolstore-microservices/favicon.png">
    
    <link rel="preload" href="/coolstore-microservices/assets/css/0.styles.125bb58c.css" as="style"><link rel="preload" href="/coolstore-microservices/assets/js/app.e9fe9b31.js" as="script"><link rel="preload" href="/coolstore-microservices/assets/js/2.aa9c82e9.js" as="script"><link rel="preload" href="/coolstore-microservices/assets/js/7.c99a5e2d.js" as="script"><link rel="prefetch" href="/coolstore-microservices/assets/js/3.68244df8.js"><link rel="prefetch" href="/coolstore-microservices/assets/js/4.7d932259.js"><link rel="prefetch" href="/coolstore-microservices/assets/js/5.e618186f.js"><link rel="prefetch" href="/coolstore-microservices/assets/js/6.393ab61d.js"><link rel="prefetch" href="/coolstore-microservices/assets/js/8.9b4eb9e6.js"><link rel="prefetch" href="/coolstore-microservices/assets/js/9.e4b84b16.js">
    <link rel="stylesheet" href="/coolstore-microservices/assets/css/0.styles.125bb58c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/coolstore-microservices/" class="home-link router-link-active"><!----> <span class="site-name">Coolstore Microservices</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/coolstore-microservices/" class="nav-link">Home</a></div> <a href="https://github.com/vietnam-devs/coolstore-microservices" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/coolstore-microservices/" class="nav-link">Home</a></div> <a href="https://github.com/vietnam-devs/coolstore-microservices" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/coolstore-microservices/" class="sidebar-link">Introduction</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/coolstore-microservices/#technical-stack" class="sidebar-link">Technical stack</a></li></ul></li><li><a href="/coolstore-microservices/model-microservices/" class="sidebar-link">Business Context</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/coolstore-microservices/model-microservices/#business-requirements" class="sidebar-link">Business Requirements</a></li><li class="sidebar-sub-header"><a href="/coolstore-microservices/model-microservices/#fine-tuning-1-finding-important-nouns-and-relationship-with-another-context" class="sidebar-link">Fine tuning 1: Finding important nouns and relationship with another context</a></li><li class="sidebar-sub-header"><a href="/coolstore-microservices/model-microservices/#conceptual-model" class="sidebar-link">Conceptual Model</a></li><li class="sidebar-sub-header"><a href="/coolstore-microservices/model-microservices/#fine-tuning-2-finding-verbs" class="sidebar-link">Fine Tuning 2: Finding verbs</a></li><li class="sidebar-sub-header"><a href="/coolstore-microservices/model-microservices/#fine-tuning-3-get-rid-of-un-important-parts" class="sidebar-link">Fine tuning 3: Get rid of un-important parts</a></li><li class="sidebar-sub-header"><a href="/coolstore-microservices/model-microservices/#usecase-view" class="sidebar-link">Usecase View</a></li><li class="sidebar-sub-header"><a href="/coolstore-microservices/model-microservices/#event-storming-1-event" class="sidebar-link">Event Storming 1: Event</a></li><li class="sidebar-sub-header"><a href="/coolstore-microservices/model-microservices/#event-storming-2-command" class="sidebar-link">Event Storming 2: Command</a></li><li class="sidebar-sub-header"><a href="/coolstore-microservices/model-microservices/#event-storming-3-invariants" class="sidebar-link">Event Storming 3: Invariants</a></li><li class="sidebar-sub-header"><a href="/coolstore-microservices/model-microservices/#event-storming-4-bounded-context-query-view-modular" class="sidebar-link">Event Storming 4: Bounded Context (Query/View -&gt; Modular)</a></li><li class="sidebar-sub-header"><a href="/coolstore-microservices/model-microservices/#event-storming-5-communication-between-bcs" class="sidebar-link">Event Storming 5: Communication between BCs</a></li></ul></li><li><a href="/coolstore-microservices/design-microservices/" class="sidebar-link">Microservices Design</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/coolstore-microservices/design-microservices/#api-design" class="sidebar-link">API Design</a></li><li class="sidebar-sub-header"><a href="/coolstore-microservices/design-microservices/#api-gateways" class="sidebar-link">API Gateways</a></li><li class="sidebar-sub-header"><a href="/coolstore-microservices/design-microservices/#interservice-communication" class="sidebar-link">Interservice Communication</a></li></ul></li><li><a href="/coolstore-microservices/development/" class="active sidebar-link">Microservices Development</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/coolstore-microservices/development/#local-development-craftmanship" class="sidebar-link">Local Development Craftmanship</a></li><li class="sidebar-sub-header"><a href="/coolstore-microservices/development/#up-and-running-with-docker-and-docker-compose" class="sidebar-link">Up and Running with Docker and Docker Compose</a></li><li class="sidebar-sub-header"><a href="/coolstore-microservices/development/#up-and-running-manually-on-docker-for-desktop-and-aks" class="sidebar-link">Up and running manually on Docker for desktop and AKS</a></li><li class="sidebar-sub-header"><a href="/coolstore-microservices/development/#up-and-running-with-kubernetes-and-istio" class="sidebar-link">Up and Running with Kubernetes and Istio</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="microservices-development"><a href="#microservices-development" aria-hidden="true" class="header-anchor">#</a> Microservices Development</h1> <h2 id="local-development-craftmanship"><a href="#local-development-craftmanship" aria-hidden="true" class="header-anchor">#</a> Local Development Craftmanship</h2> <h3 id="netcorekit"><a href="#netcorekit" aria-hidden="true" class="header-anchor">#</a> NetCoreKit</h3> <p>All .NET microservices are developed by using <a href="https://github.com/cloudnative-netcore/netcorekit" target="_blank" rel="noopener noreferrer">NetCoreKit<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> library. So we need to make it as a <code>submodule</code> in <code>coolstore-microservices</code> project.</p> <h4 id="remove-submodule"><a href="#remove-submodule" aria-hidden="true" class="header-anchor">#</a> Remove submodule</h4> <p>If you have already added submodules for <code>netcorekit</code>, then you need to remove it first. Let doing following steps to remove it.</p> <p>At root of <code>coolstore-microservices</code> project, run command below</p> <div class="language- extra-class"><pre class="language-text"><code>&gt; rm -Rf src\netcorekit
&gt; rm -rf .git\modules\src
</code></pre></div><p>Then open up <code>.git\config</code> file, and delete the section with <code>src\netcorekit</code>.</p> <p>Refs:</p> <ul><li>https://stackoverflow.com/questions/12218420/add-a-submodule-which-cant-be-removed-from-the-index/39189599</li> <li>https://stackoverflow.com/questions/43789152/git-removing-submodule-error</li></ul> <h4 id="add-submodule"><a href="#add-submodule" aria-hidden="true" class="header-anchor">#</a> Add submodule</h4> <p>Run the command at the root of <code>coolstore-microservices</code> project as following</p> <div class="language- extra-class"><pre class="language-text"><code>&gt; git submodule add https://github.com/cloudnative-netcore/netcorekit src/netcorekit
</code></pre></div><p>It should create a file <code>.gitmodules</code> with the content as below</p> <div class="language- extra-class"><pre class="language-text"><code>[submodule &quot;src/netcorekit&quot;]
	path = src/netcorekit
	url = https://github.com/cloudnative-netcore/netcorekit
	ignore = dirty
</code></pre></div><h4 id="update-submodule"><a href="#update-submodule" aria-hidden="true" class="header-anchor">#</a> Update submodule</h4> <p>To update the content from <code>NetCoreKit</code> project, run</p> <div class="language- extra-class"><pre class="language-text"><code>&gt; git submodule foreach git pull origin master
</code></pre></div><p>Reference at https://stackoverflow.com/questions/5828324/update-git-submodule-to-latest-commit-on-origin</p> <p><em>Notes</em>: we can also check out a branch or a tag at https://stackoverflow.com/questions/1777854/how-can-i-specify-a-branch-tag-when-adding-a-git-submodule</p> <h3 id="identity-server"><a href="#identity-server" aria-hidden="true" class="header-anchor">#</a> Identity Server</h3> <ul><li>IdentityServer4</li></ul> <h4 id="postman"><a href="#postman" aria-hidden="true" class="header-anchor">#</a> Postman</h4> <p><img src="/coolstore-microservices/postman-graphql.png" alt=""></p> <blockquote><p>TODO</p></blockquote> <h4 id="open-api"><a href="#open-api" aria-hidden="true" class="header-anchor">#</a> Open API</h4> <blockquote><p>TODO</p></blockquote> <h4 id="graphql-server"><a href="#graphql-server" aria-hidden="true" class="header-anchor">#</a> GraphQL Server</h4> <blockquote><p>TODO</p></blockquote> <h4 id="front-and-back-office-websites"><a href="#front-and-back-office-websites" aria-hidden="true" class="header-anchor">#</a> Front and Back Office Websites</h4> <blockquote><p>TODO</p></blockquote> <h3 id="grpc-service"><a href="#grpc-service" aria-hidden="true" class="header-anchor">#</a> gRPC Service</h3> <ul><li>Grpc</li> <li>Google.Protobuf</li> <li>Google.Api.Gax.Grpc</li></ul> <p>Before you can generate <code>gRPC</code> files for all microservices in this project you need to install some of tool as below</p> <h4 id="install-protoc-gen-swagger"><a href="#install-protoc-gen-swagger" aria-hidden="true" class="header-anchor">#</a> Install <code>protoc-gen-swagger</code></h4> <p>This will help to generate <code>Open Api</code> file (former is <code>Swagger</code>), and used in <code>./src/services/open-api</code> service</p> <p>More information can be found at https://github.com/grpc-ecosystem/grpc-gateway</p> <div class="language-bash extra-class"><pre class="language-bash"><code>go get -u github.com/grpc-ecosystem/grpc-gateway/protoc-gen-swagger
</code></pre></div><p>At the root of each microservice, we put one <code>bash</code> script with named <code>cmd_gen_proto.sh</code> so that you can generate standalone <code>gRPC</code> files for each service, and if you want to generate <code>gRPC</code> files for all of them, then you can access and run at <code>./deploys/scripts/gen-protos.sh</code></p> <h3 id="envoy-proxy"><a href="#envoy-proxy" aria-hidden="true" class="header-anchor">#</a> Envoy Proxy</h3> <ul><li>envoy-proxy</li></ul> <blockquote><p>TODO</p></blockquote> <h3 id="open-api-2"><a href="#open-api-2" aria-hidden="true" class="header-anchor">#</a> Open Api</h3> <ul><li>Swashbuckle.AspNetCore.SwaggerUI</li></ul> <blockquote><p>TODO</p></blockquote> <h3 id="graphql-server-2"><a href="#graphql-server-2" aria-hidden="true" class="header-anchor">#</a> GraphQL Server</h3> <ul><li>tanka.graphql</li> <li>tanka.graphql.server</li> <li>GraphQL.Server.Ui.Playground</li> <li>GraphQL.Server.Ui.Voyager</li></ul> <blockquote><p>TODO</p></blockquote> <h3 id="front-and-back-office-websites-2"><a href="#front-and-back-office-websites-2" aria-hidden="true" class="header-anchor">#</a> Front and back office websites</h3> <h4 id="front-office-website"><a href="#front-office-website" aria-hidden="true" class="header-anchor">#</a> Front office website</h4> <ul><li>vuejs</li> <li>webpack</li></ul> <blockquote><p>TODO</p></blockquote> <h4 id="back-office-website"><a href="#back-office-website" aria-hidden="true" class="header-anchor">#</a> Back office website</h4> <ul><li><p>create-react-app</p></li> <li><p>apollo-client</p></li> <li><p>tanka-graphql-client</p></li> <li><p>At the root of <code>src/backoffice</code>, we create a <code>.env</code> with content as below</p></li></ul> <div class="language- extra-class"><pre class="language-text"><code>REACT_APP_GRAPHQL_ENDPOINT=http://localhost:5011
REACT_APP_AUTHORITY=http://localhost:56219
REACT_APP_ROOT_URL=http://localhost:3000
REACT_APP_CLIENT_ID=backoffice
</code></pre></div><p>This will point to the local graphql endpoint. When we deploy it to production, we will ovewrite it with another configuration</p> <ul><li>Then we run <code>yarn start</code> to start development the <code>back-office</code> app</li></ul> <h2 id="up-and-running-with-docker-and-docker-compose"><a href="#up-and-running-with-docker-and-docker-compose" aria-hidden="true" class="header-anchor">#</a> Up and Running with Docker and Docker Compose</h2> <h3 id="environment-variables"><a href="#environment-variables" aria-hidden="true" class="header-anchor">#</a> Environment variables</h3> <p>To developing in the localhost, we need to add <code>.env</code> file and put it to the root of <code>coolstore-microservices</code> project. The content of it as below</p> <div class="language- extra-class"><pre class="language-text"><code>WEB_PORT=8084
BACKOFFICE_PORT=3000

OPENAPI_SVR_PORT=5010
GRAPHQL_SVR_PORT=5011
IDP_SVR_PORT=8085

CATALOG_SVC_PORT=5002
CART_SVC_PORT=5003
INVENTORY_SVC_PORT=5004
RATING_SVC_PORT=5007

MONGODB_PORT=27017
MYSQLDB_PORT=3306

HOST_IP=&lt;localhost ip get from ipconfig&gt;
</code></pre></div><h3 id="protobuf"><a href="#protobuf" aria-hidden="true" class="header-anchor">#</a> Protobuf</h3> <p>In each microservices, we also have <code>cmd_gen_proto.sh</code> to use <code>protobuf</code> tools which generates <code>C#</code> target file for .NET microservice project.</p> <h3 id="docker"><a href="#docker" aria-hidden="true" class="header-anchor">#</a> Docker</h3> <p>In each microservices, we also have <code>cmd_build_image.sh</code> to build the standalone service and tag it with <code>vndg</code> prefix.</p> <h3 id="docker-compose"><a href="#docker-compose" aria-hidden="true" class="header-anchor">#</a> Docker Compose</h3> <p>To make the development easy, we've usually used <code>docker-compose</code> to boost up all microservices and related components. We can make it run or debug the local microservices using this approach</p> <p>Library and tool:</p> <ul><li>Docker Compose</li> <li>Envoy Proxy</li> <li>Open Api</li> <li>Rest and gRPC protocols</li></ul> <p>We support 4 modes of docker-compose at the moment:</p> <ul><li><code>docker-compose.yml</code>: full running with all services, server and web endpoints</li> <li><code>docker-compose-graphql.yml</code>: only graphql endpoints with its backoffice app</li> <li><code>docker-compose-graphql.headless.yml</code>: only headless graphql endpoints</li> <li><code>docker-compose-graphql.dev.yml</code>: only microservices</li></ul> <h4 id="list-of-endpoints"><a href="#list-of-endpoints" aria-hidden="true" class="header-anchor">#</a> List of endpoints</h4> <h5 id="envoy-proxy-endpoints"><a href="#envoy-proxy-endpoints" aria-hidden="true" class="header-anchor">#</a> Envoy Proxy Endpoints</h5> <ul><li>Main Uri: http://localhost:8082</li> <li>Admin Uri: http://localhost:8081</li></ul> <h5 id="web-ui-endpoint"><a href="#web-ui-endpoint" aria-hidden="true" class="header-anchor">#</a> Web UI Endpoint</h5> <ul><li>http://localhost:8084</li></ul> <h5 id="identity-server-endpoint"><a href="#identity-server-endpoint" aria-hidden="true" class="header-anchor">#</a> Identity Server Endpoint</h5> <ul><li>http://localhost:8085</li></ul> <h5 id="open-api-endpoint"><a href="#open-api-endpoint" aria-hidden="true" class="header-anchor">#</a> Open Api Endpoint</h5> <ul><li>http://localhost:8082/oai/</li></ul> <h5 id="graphql-endpoint"><a href="#graphql-endpoint" aria-hidden="true" class="header-anchor">#</a> GraphQL Endpoint</h5> <ul><li>http://localhost:8082/gql/graphiql</li> <li>http://localhost:8082/gql/playground</li> <li>http://localhost:8082/gql/voyager</li></ul> <h4 id="debugging"><a href="#debugging" aria-hidden="true" class="header-anchor">#</a> Debugging</h4> <p>Let says we want to debug <code>cart-service</code> so we need to do some steps below</p> <h5 id="step-1"><a href="#step-1" aria-hidden="true" class="header-anchor">#</a> <em>Step 1</em>:</h5> <p>Open <code>docker-compose.yml</code>, find the section below, then comment or remove it</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">cart-service</span><span class="token punctuation">:</span>
  <span class="token key atrule">container_name</span><span class="token punctuation">:</span> cart<span class="token punctuation">-</span>service
  <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">'vndg/cs-cart-service'</span>
  <span class="token key atrule">restart</span><span class="token punctuation">:</span> always
  <span class="token key atrule">environment</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> Features__EfCore__MySqlDb__FQDN=mysqldb<span class="token punctuation">:</span><span class="token number">3306</span>
  <span class="token key atrule">ports</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">'5003:5003'</span>
  <span class="token key atrule">expose</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token string">'5003'</span>
  <span class="token key atrule">build</span><span class="token punctuation">:</span>
    <span class="token key atrule">context</span><span class="token punctuation">:</span> .
    <span class="token key atrule">dockerfile</span><span class="token punctuation">:</span> ./src/services/cart/Dockerfile
</code></pre></div><h5 id="step-2"><a href="#step-2" aria-hidden="true" class="header-anchor">#</a> <em>Step 2</em>:</h5> <p>Open <code>src/deploys/dockers/envoy-proxy/envoy.yaml</code> file, then change a bit as below</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> cart_grpc_service
  <span class="token key atrule">connect_timeout</span><span class="token punctuation">:</span> 0.25s
  <span class="token key atrule">type</span><span class="token punctuation">:</span> static
  <span class="token key atrule">lb_policy</span><span class="token punctuation">:</span> round_robin
  <span class="token key atrule">http2_protocol_options</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token key atrule">hosts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">socket_address</span><span class="token punctuation">:</span>
        <span class="token key atrule">address</span><span class="token punctuation">:</span> 192.168.137.1
        <span class="token key atrule">port_value</span><span class="token punctuation">:</span> <span class="token number">5006</span>
</code></pre></div><p><code>type</code> should change to <code>static</code>, and <code>address</code> should be your real IP of the laptop you run</p> <p>Then, on the command prompt type <code>bash</code>, and <code>./deploys/dockers/envoy-proxy/cmd_build_image.sh</code></p> <h5 id="step-3"><a href="#step-3" aria-hidden="true" class="header-anchor">#</a> <em>Step 3</em>:</h5> <p>Run <code>docker-compose up</code></p> <h5 id="step-4"><a href="#step-4" aria-hidden="true" class="header-anchor">#</a> <em>Step 4</em>:</h5> <p>Run your gRPC service in debug mode</p> <h5 id="step-5"><a href="#step-5" aria-hidden="true" class="header-anchor">#</a> <em>Step 5</em>:</h5> <p>Go to <code>http://localhost:8082/oai/swagger/index.html</code>, click to any <code>cart-service</code> endpoints in there</p> <p>Enjoy your hack!</p> <h2 id="up-and-running-manually-on-docker-for-desktop-and-aks"><a href="#up-and-running-manually-on-docker-for-desktop-and-aks" aria-hidden="true" class="header-anchor">#</a> Up and running manually on Docker for desktop and AKS</h2> <h3 id="docker-for-desktop"><a href="#docker-for-desktop" aria-hidden="true" class="header-anchor">#</a> Docker for desktop</h3> <h4 id="step-1-2"><a href="#step-1-2" aria-hidden="true" class="header-anchor">#</a> Step 1</h4> <p>Make sure we have <strong><code>Docker for Desktop</code></strong> running with <strong><code>Kubernetes</code></strong> option enabled. We need to install <strong><code>kubectl</code></strong>, <strong><code>helm</code></strong> and <strong><code>istioctl</code></strong> on the build machine as well.</p> <h4 id="step-2-2"><a href="#step-2-2" aria-hidden="true" class="header-anchor">#</a> Step 2</h4> <p>From current console, type <code>bash</code> to enter <code>Linux Subsystem (Ubuntu)</code></p> <h4 id="step-3-2"><a href="#step-3-2" aria-hidden="true" class="header-anchor">#</a> Step 3</h4> <p>Then <code>cd</code> into your root of project</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ ./deploys/scripts/build-images.sh
</code></pre></div><p>It should run and package all docker images.</p> <p><em><strong>Notes</strong></em>: it normally takes around 20 minutes for the first time</p> <h4 id="step-4-2"><a href="#step-4-2" aria-hidden="true" class="header-anchor">#</a> Step 4</h4> <p>Download and install <a href="https://github.com/istio/istio/releases/tag/1.1.1" target="_blank" rel="noopener noreferrer">istio-1.1.1<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> on the box, and unzip it into somewhere, then initialize it with following commands</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token builtin class-name">cd</span> <span class="token operator">&lt;</span>istio-1.1.1 path<span class="token operator">&gt;</span>
$ kubectl create -f install/kubernetes/helm/helm-service-account.yaml
$ helm init --service-account tiller --upgrade
$ helm <span class="token function">install</span> install/kubernetes/helm/istio --name istio --namespace istio-system
</code></pre></div><p>More information about installing <code>istio</code> can be found at https://istio.io/docs/setup/kubernetes/helm-install</p> <h4 id="step-5-2"><a href="#step-5-2" aria-hidden="true" class="header-anchor">#</a> Step 5</h4> <p>Apply <code>istioctl</code> command to <code>coolstore</code> chart (please create k8s folder in folder deploys)</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ helm template deploys/charts/coolstore -f deploys/charts/coolstore/values.dev.yaml <span class="token operator">&gt;</span> deploys/out/coolstore.local.yaml
$ istioctl kube-inject -f deploys/out/coolstore.local.yaml <span class="token operator">|</span> kubectl apply -f -
</code></pre></div><h4 id="step-6"><a href="#step-6" aria-hidden="true" class="header-anchor">#</a> Step 6</h4> <p>Add hosts file with following content</p> <div class="language- extra-class"><pre class="language-text"><code>127.0.0.1 api.coolstore.local
127.0.0.1 id.coolstore.local
127.0.0.1 coolstore.local
127.0.0.1 backoffice.coolstore.local
</code></pre></div><p>Waiting for the container provision completed</p> <h4 id="step-7"><a href="#step-7" aria-hidden="true" class="header-anchor">#</a> Step 7</h4> <p>Install <code>coolstore-istio</code> chart</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ helm <span class="token function">install</span> deploys<span class="token punctuation">\</span>charts<span class="token punctuation">\</span>coolstore-istio --name coolstore-istio
</code></pre></div><h4 id="step-8"><a href="#step-8" aria-hidden="true" class="header-anchor">#</a> Step 8</h4> <p>Install <code>envoy-proxy</code> stuffs for routing directly from Rest to internal gRPC services</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ kubectl apply -f deploys<span class="token punctuation">\</span>k8s<span class="token punctuation">\</span>istio-sidecar-injector.yaml
$ kubectl apply -f deploys<span class="token punctuation">\</span>k8s<span class="token punctuation">\</span>envoy-filter.yaml
</code></pre></div><h4 id="step-9"><a href="#step-9" aria-hidden="true" class="header-anchor">#</a> Step 9</h4> <p>Access to following URLs</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">curl</span> -I http://coolstore.local <span class="token comment"># website</span>
$ <span class="token function">curl</span> -I http://backoffice.coolstore.local <span class="token comment"># backoffice website</span>
$ <span class="token function">curl</span> -I http://api.coolstore.local <span class="token comment"># api gateway</span>
$ <span class="token function">curl</span> -I http://id.coolstore.local <span class="token comment"># identity provider</span>
</code></pre></div><h4 id="step-10"><a href="#step-10" aria-hidden="true" class="header-anchor">#</a> Step 10</h4> <p>Clean up <code>coolstore</code> chart as</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ kubectl delete -f deployment/istio/coolstore.local.yaml
$ helm delete coolstore-istio --purge
$ helm delete istio --purge
</code></pre></div><p><strong><em>Notes</em></strong>:</p> <ul><li><p>Global path: set <code>PATH</code> for <code>docker</code>, <code>kubectl</code>, <code>helm</code>, and <code>istioctl</code>.</p></li> <li><p>Run with Nginx (not recommendation): if you want to run just only <code>Kubernetes</code> + <code>nginx-ingress</code> go to <code>deploys/charts/coolstore/values.yaml</code>, and modify as following</p> <div class="language-bash extra-class"><pre class="language-bash"><code>nginx:
   enabled: <span class="token boolean">true</span>
</code></pre></div><p>Then run the <code>helm</code> command as</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ helm <span class="token function">install</span> --name cs-nginx stable/nginx-ingress
</code></pre></div></li></ul> <h3 id="azure-kubernetes-service-aks"><a href="#azure-kubernetes-service-aks" aria-hidden="true" class="header-anchor">#</a> Azure Kubernetes Service (AKS)</h3> <h4 id="step-1-install-docker-for-windows-and-enable-kubernetes-ubuntu-wsl-kubectl-istioctl-helm-and-az"><a href="#step-1-install-docker-for-windows-and-enable-kubernetes-ubuntu-wsl-kubectl-istioctl-helm-and-az" aria-hidden="true" class="header-anchor">#</a> Step 1: Install Docker for Windows and enable Kubernetes, Ubuntu WSL, kubectl, istioctl, helm and az</h4> <h4 id="step-2-create-coolstore-aks-enabled-rbac-minimum-should-have-3-nodes-istio-pilot-needs-it"><a href="#step-2-create-coolstore-aks-enabled-rbac-minimum-should-have-3-nodes-istio-pilot-needs-it" aria-hidden="true" class="header-anchor">#</a> Step 2: Create coolstore AKS, enabled RBAC. Minimum should have 3 nodes (istio pilot needs it)</h4> <p><img src="/coolstore-microservices/create-cluster-aks-1.png" alt=""></p> <p>And make sure checking to <code>enable RBAC</code> as following</p> <p><img src="/coolstore-microservices/create-cluster-aks-2.png" alt=""></p> <p>Follow up with next steps to finish creating the cluster. It normally takes around <code>20 to 30 minutes</code>.</p> <p>After it finished, we should be able to access to the <code>Kubernetes Dashboard</code> with following steps</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ az aks get-credentials --resource-group coolstore --name coolstore
$ kubectl proxy
</code></pre></div><p>But now, you will not be able to access to Kubernetes Dashboard. Then we need to add several steps then</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ kubectl create clusterrolebinding kubernetes-dashboard -n kube-system --clusterrole<span class="token operator">=</span>cluster-admin --serviceaccount<span class="token operator">=</span>kube-system:kubernetes-dashboard
</code></pre></div><p>Get the <code>token</code> subsequently</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ kubectl get secret <span class="token punctuation">\</span><span class="token variable"><span class="token variable">$(</span>kubectl get serviceaccount kubernetes-dashboard -n kube-system -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">&quot;{.secrets[0].name}&quot;</span><span class="token variable">)</span></span> -n kube-system -o <span class="token assign-left variable">jsonpath</span><span class="token operator">=</span><span class="token string">&quot;{.data.token}&quot;</span> <span class="token operator">|</span> base64 --decode
</code></pre></div><p>Paste the token to login page as http://localhost:8001/api/v1/namespaces/kube-system/services/kubernetes-dashboard/proxy/#!/login</p> <h4 id="step-3-install-istio-on-aks"><a href="#step-3-install-istio-on-aks" aria-hidden="true" class="header-anchor">#</a> Step 3: Install Istio on AKS</h4> <p>Due to some of the timeout issues for helm at now so that I couldn’t use helm to install, but <code>export</code> it to yaml file, then using kubectl to create it on AKS. <code>Download istio 1.0.0</code>, then upzip to somewhere on the machine. Following command to export and deploy it to AKS</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ helm template install/kubernetes/helm/istio --namespace istio-system <span class="token operator">&gt;</span> istio-dump.yaml
$ kubectl create -f istio-dump.yaml
$ kubectl create -f istio-dump.yaml
</code></pre></div><h4 id="step-4-install-coolstore-on-aks"><a href="#step-4-install-coolstore-on-aks" aria-hidden="true" class="header-anchor">#</a> Step 4: Install Coolstore on AKS</h4> <p>Get the <code>internal istio-ingress IP</code> by using</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ kubectl get services istio-ingressgateway -n istio-system -o<span class="token operator">=</span>jsonpath<span class="token operator">=</span><span class="token punctuation">{</span>.spec.clusterIP<span class="token punctuation">}</span>
</code></pre></div><p>Create the <code>values.aks.yaml</code> with content like</p> <p>gateway:
ip: 10.0.106.82</p> <p>Then run helm command</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ helm template deploys/charts/coolstore -f deploys/charts/coolstore/values.aks.yaml <span class="token operator">&gt;</span> deploys/k8s/dev-all-in-one.aks.yaml
</code></pre></div><p>Finally, we <code>inject sidecar</code> with this command</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ istioctl kube-inject -f deploys/k8s/dev-all-in-one.aks.yaml <span class="token operator">|</span> kubectl apply -f -
</code></pre></div><h4 id="step-5-put-mapping-for-hosts-file"><a href="#step-5-put-mapping-for-hosts-file" aria-hidden="true" class="header-anchor">#</a> Step 5: Put mapping for hosts file</h4> <p>Get <code>external IP</code> on istio ingress by using</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ kubectl get svc -n istio-system
</code></pre></div><p>It should print out something like</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">..</span>.
istio-ingressgateway LoadBalancer <span class="token number">10.106</span>.52.19 localhost <span class="token number">80</span>:31380/TCP,443:31390/TCP,31400:31400/TCP,15011:32131/TCP,8060:30958/TCP,15030:31983/TCP,15031:30365/TCP 8d
<span class="token punctuation">..</span>.
</code></pre></div><p>Then, we only need to copy <code>10.106.52.19</code> to <code>C:\Windows\System32\drivers\etc\hosts</code> file as following</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">10.106</span>.52.19 id.coolstore.aks
<span class="token number">10.106</span>.52.19 api.coolstore.aks
<span class="token number">10.106</span>.52.19 coolstore.aks
<span class="token number">10.106</span>.52.19 backoffice.coolstore.aks
</code></pre></div><p>From now on, we can access website at <code>http://coolstore.aks</code>, backoffice website at <code>http://backoffice.coolstore.aks</code>, identity provider at <code>http://id.coolstore.aks</code>, and api gateway at <code>http://api.coolstore.aks</code></p> <p>Let say we access to <code>http://api.coolstore.aks/oai/swagger/index.html</code>, then we should see</p> <p><img src="/coolstore-microservices/open-api.png" alt=""></p> <p>More information at https://hackernoon.com/5-steps-to-bring-coolstores-service-mesh-to-azure-kubernetes-service-aks-9cd1a5aa008a</p> <h2 id="up-and-running-with-kubernetes-and-istio"><a href="#up-and-running-with-kubernetes-and-istio" aria-hidden="true" class="header-anchor">#</a> Up and Running with Kubernetes and Istio</h2> <h3 id="kubernetes"><a href="#kubernetes" aria-hidden="true" class="header-anchor">#</a> Kubernetes</h3> <p>TODO</p> <h3 id="istio"><a href="#istio" aria-hidden="true" class="header-anchor">#</a> Istio</h3> <p>TODO</p> <h4 id="logging-and-monitoring"><a href="#logging-and-monitoring" aria-hidden="true" class="header-anchor">#</a> Logging and Monitoring</h4> <p>TODO</p> <h3 id="ci-cd"><a href="#ci-cd" aria-hidden="true" class="header-anchor">#</a> CI/CD</h3> <p>TODO</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/coolstore-microservices/design-microservices/" class="prev">
          Microservices Design
        </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/coolstore-microservices/assets/js/app.e9fe9b31.js" defer></script><script src="/coolstore-microservices/assets/js/2.aa9c82e9.js" defer></script><script src="/coolstore-microservices/assets/js/7.c99a5e2d.js" defer></script>
  </body>
</html>
